<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rendición de Gastos Empresarial</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1e3a8a">

<script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>

<style>
body{font-family:Arial;margin:0;background:#f4f6f9}
header{background:#1e3a8a;color:white;padding:15px;text-align:center}
.container{padding:20px;max-width:1000px;margin:auto}
.card{background:white;padding:20px;border-radius:10px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,0.1)}
input,select,textarea{width:100%;padding:8px;margin:5px 0 10px;border-radius:5px;border:1px solid #ccc}
button{padding:10px 15px;border:none;border-radius:6px;cursor:pointer;margin:5px 0}
.btn-primary{background:#2563eb;color:white}
.btn-success{background:#16a34a;color:white}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid #ddd;padding:8px;text-align:left}
.preview{width:60px;border-radius:6px}
@media(max-width:600px){.container{padding:10px}}
</style>
</head>
<body>

<header><h2>Rendición de Gastos Empresarial</h2></header>

<div class="container">
<div class="card">
<h3>Registrar Gasto</h3>
<input id="fecha" type="date">
<input id="empresa" placeholder="Empresa">
<input id="monto" type="number" placeholder="Monto">
<input id="imagen" type="file" accept="image/*">
<button id="btnGuardar" class="btn-primary">Guardar</button>
</div>

<div class="card">
<h3>Listado</h3>
<div id="tabla"></div>
<button id="btnExportar" class="btn-success">Exportar Excel con Imagen</button>
</div>
</div>

<script>
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js');
}

document.addEventListener("DOMContentLoaded", function(){

const KEY="gastos_pro_v1";

const fecha=document.getElementById("fecha");
const empresa=document.getElementById("empresa");
const monto=document.getElementById("monto");
const imagen=document.getElementById("imagen");
const tabla=document.getElementById("tabla");

function cargar(){return JSON.parse(localStorage.getItem(KEY))||[];}
function guardar(d){localStorage.setItem(KEY,JSON.stringify(d));render();}

function render(){
const data=cargar();
if(!data.length){tabla.innerHTML="<p>Sin registros</p>";return;}
let html="<table><tr><th>Fecha</th><th>Empresa</th><th>Monto</th><th>Img</th></tr>";
data.forEach(g=>{
html+=`<tr>
<td>${g.fecha}</td>
<td>${g.empresa}</td>
<td>$${g.monto}</td>
<td>${g.imagen?`<img src="${g.imagen}" class="preview">`:"-"}</td>
</tr>`;
});
html+="</table>";
tabla.innerHTML=html;
}

document.getElementById("btnGuardar").onclick=function(){
if(!fecha.value||!empresa.value||!monto.value){alert("Completa campos");return;}
const file=imagen.files[0];
if(file){
const reader=new FileReader();
reader.onload=e=>{
guardar([...cargar(),{
fecha:fecha.value,
empresa:empresa.value,
monto:monto.value,
imagen:e.target.result
}]);
};
reader.readAsDataURL(file);
}else{
guardar([...cargar(),{
fecha:fecha.value,
empresa:empresa.value,
monto:monto.value,
imagen:null
}]);
}
fecha.value="";empresa.value="";monto.value="";imagen.value="";
};

document.getElementById("btnExportar").onclick=async function(){
const workbook=new ExcelJS.Workbook();
const sheet=workbook.addWorksheet("Gastos");
sheet.columns=[
{header:"Fecha",key:"fecha",width:15},
{header:"Empresa",key:"empresa",width:20},
{header:"Monto",key:"monto",width:15},
{header:"Imagen",key:"imagen",width:25}
];

const data=cargar();

for(let i=0;i<data.length;i++){
const g=data[i];
const row=sheet.addRow({fecha:g.fecha,empresa:g.empresa,monto:g.monto});
if(g.imagen){
const imgId=workbook.addImage({
base64:g.imagen,
extension:'png'
});
sheet.addImage(imgId,{
tl:{col:3,row:i+1},
ext:{width:80,height:60}
});
}
}

const buffer=await workbook.xlsx.writeBuffer();
const blob=new Blob([buffer]);
const link=document.createElement("a");
link.href=URL.createObjectURL(blob);
link.download="Rendicion_con_imagen.xlsx";
link.click();
};

render();
});
</script>

</body>
</html>
