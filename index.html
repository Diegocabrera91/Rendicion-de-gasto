<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rendici√≥n de Gastos - TOOLTEK SPA</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --tooltek-blue: #1a5a8e;
            --tooltek-aqua: #00a8cc;
            --bg-base: #f8fafc;
            --bg-card: #ffffff;
            --text-primary: #0f172a;
            --border: #e2e8f0;
            --success: #10b981;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-base); color: var(--text-primary); line-height: 1.6; }
        header { background: linear-gradient(135deg, var(--tooltek-blue), var(--tooltek-aqua)); color: white; padding: 20px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        header img { height: 120px; max-width: 100%; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .form-section, .tabla-section { background: var(--bg-card); padding: 24px; border-radius: 12px; margin-bottom: 24px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 20px; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 16px; }
        input[type="file"] { padding: 8px; }
        input:focus, select:focus { outline: none; border-color: var(--tooltek-blue); box-shadow: 0 0 0 3px rgba(26,90,142,0.1); }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; transition: all 0.2s; margin: 4px; }
        .btn-primary { background: var(--tooltek-blue); color: white; }
        .btn-primary:hover { background: #144a72; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-secondary { background: #6b7280; color: white; }
        table { width: 100%; border-collapse: collapse; margin-top: 16px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border); }
        th { background: var(--tooltek-blue); color: white; font-weight: 600; }
        tr:hover { background: #f1f5f9; }
        .img-preview { max-width: 50px; max-height: 50px; border-radius: 4px; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-top: 20px; }
        .stat-card { background: linear-gradient(135deg, var(--tooltek-aqua), #00d4ff); color: white; padding: 20px; border-radius: 12px; text-align: center; }
        .alert { padding: 12px; border-radius: 8px; margin: 16px 0; }
        .alert-success { background: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; }
        @media (max-width: 768px) { .form-grid { grid-template-columns: 1fr; } header img { height: 100px; } }
    </style>
</head>
<body>
    <header>
        <img src="https://raw.githubusercontent.com/diegocabrera91/Rendicion-de-gasto/main/logo.png" alt="TOOLTEK SPA" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjgwIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMjQiIGZpbGw9IiMxYTVhOGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5UT09MS0VLIFNQQTwvdGV4dD48L3N2Zz4='">
        <h1>Sistema de Rendici√≥n de Gastos</h1>
    </header>
    <div class="container">
        <div class="form-section">
            <h2>üìù Nuevo Gasto</h2>
            <div class="form-grid">
                <input type="date" id="fecha" required>
                <select id="tipoGasto" required>
                    <option value="">Tipo de Gasto</option>
                    <option>Gastos de Traslado por Representacion</option>
                    <option>Gastos de Alimentacion por Representacion</option>
                    <option>Gastos de Hospedaje por Representacion</option>
                    <option>Gastos de Vehiculo por Representacion</option>
                    <option>Gastos de Combustible por Representacion</option>
                    <option>Otros Gastos por Representacion</option>
                </select>
                <select id="tipoDoc" required>
                    <option value="">Tipo Documento</option>
                    <option>Boleta</option>
                    <option>Factura</option>
                </select>
                <input type="text" id="numDoc" placeholder="N√∫mero Documento" required>
                <input type="text" id="rut" placeholder="RUT (solo Factura)">
                <input type="text" id="empresa" placeholder="Empresa/Proveedor" required>
                <input type="number" id="monto" placeholder="Monto CLP" step="0.01" required>
                <textarea id="descripcion" placeholder="Descripci√≥n" rows="2"></textarea>
                <input type="file" id="imagenes" multiple accept="image/*" capture="environment">
            </div>
            <div>
                <button class="btn btn-primary" id="btnAgregar">‚ûï Agregar Gasto</button>
                <button class="btn btn-secondary" id="btnLimpiar">üßπ Limpiar</button>
            </div>
        </div>
        <div class="tabla-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h2>üìä Gastos Registrados (<span id="totalGastos">0</span>)</h2>
                <div>
                    <button class="btn btn-danger" id="btnEliminarTodo">üóëÔ∏è Eliminar Todo</button>
                    <button class="btn btn-success" id="btnExportar">üì• Exportar Excel</button>
                </div>
            </div>
            <table id="tablaGastos">
                <thead><tr><th>Fecha</th><th>Tipo Gasto</th><th>Doc</th><th>N¬∞</th><th>RUT</th><th>Empresa</th><th>Monto</th><th>Im√°genes</th><th>Acciones</th></tr></thead>
                <tbody></tbody>
            </table>
            <div class="stats">
                <div class="stat-card">
                    <h3 id="totalMonto">0</h3>
                    <p>Total Gastos</p>
                </div>
                <div class="stat-card">
                    <h3 id="promedioMonto">0</h3>
                    <p>Promedio por Gasto</p>
                </div>
            </div>
            <div id="alertas"></div>
        </div>
    </div>
    <script>
        let gastos = JSON.parse(localStorage.getItem('gastos')) || [];
        let imagenesActuales = [];

        function mostrarAlerta(mensaje, tipo = 'success') {
            const alertas = document.getElementById('alertas');
            const alerta = document.createElement('div');
            alerta.className = `alert alert-${tipo}`;
            alerta.textContent = mensaje;
            alertas.appendChild(alerta);
            setTimeout(() => alerta.remove(), 5000);
        }

        async function archivosABase64(files) {
            const base64Array = [];
            for (let file of files) {
                const base64 = await new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.readAsDataURL(file);
                });
                base64Array.push(base64);
            }
            return base64Array;
        }

        function guardarGastos() {
            localStorage.setItem('gastos', JSON.stringify(gastos));
        }

        function actualizarTabla() {
            const tbody = document.querySelector('#tablaGastos tbody');
            tbody.innerHTML = '';
            gastos.forEach((gasto, index) => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${new Date(gasto.fecha).toLocaleDateString('es-CL')}</td>
                    <td>${gasto.tipoGasto}</td>
                    <td>${gasto.tipoDoc}</td>
                    <td>${gasto.numDoc}</td>
                    <td>${gasto.rut || ''}</td>
                    <td>${gasto.empresa}</td>
                    <td>$${parseFloat(gasto.monto).toLocaleString('es-CL')}</td>
                    <td>${gasto.imagenes?.map((img, i) => `<img src="${img}" class="img-preview" title="Img ${i+1}">`).join(' ') || ''}</td>
                    <td><button class="btn btn-danger" onclick="eliminarGasto(${index})">üóëÔ∏è</button></td>
                `;
            });
            document.getElementById('totalGastos').textContent = gastos.length;
            actualizarEstadisticas();
            guardarGastos();
        }

        function actualizarEstadisticas() {
            const total = gastos.reduce((sum, g) => sum + parseFloat(g.monto || 0), 0);
            const count = gastos.length;
            document.getElementById('totalMonto').textContent = '$' + total.toLocaleString('es-CL');
            document.getElementById('promedioMonto').textContent = count ? (total / count).toLocaleString('es-CL') : '0';
        }

        function agregarGasto() {
            const gasto = {
                fecha: document.getElementById('fecha').value,
                tipoGasto: document.getElementById('tipoGasto').value,
                tipoDoc: document.getElementById('tipoDoc').value,
                numDoc: document.getElementById('numDoc').value,
                rut: document.getElementById('rut').value || '',
                empresa: document.getElementById('empresa').value,
                monto: document.getElementById('monto').value,
                descripcion: document.getElementById('descripcion').value,
                imagenes: [...imagenesActuales]
            };
            if (!gasto.fecha || !gasto.tipoGasto || !gasto.tipoDoc || !gasto.numDoc || !gasto.empresa || !gasto.monto) {
                mostrarAlerta('Completa todos los campos obligatorios', 'error');
                return;
            }
            gastos.push(gasto);  // ‚úÖ AGREGA AL ARRAY
            limpiarFormulario();
            actualizarTabla();
            mostrarAlerta(`‚úÖ Gasto agregado. Total: ${gastos.length}`);
        }

        function limpiarFormulario() {
            document.getElementById('fecha').value = new Date().toISOString().split('T')[0];
            document.getElementById('tipoGasto').value = '';
            document.getElementById('tipoDoc').value = '';
            document.getElementById('numDoc').value = '';
            document.getElementById('rut').value = '';
            document.getElementById('empresa').value = '';
            document.getElementById('monto').value = '';
            document.getElementById('descripcion').value = '';
            imagenesActuales = [];
            document.getElementById('imagenes').value = '';
        }

        function eliminarGasto(index) {
            if (confirm('¬øEliminar este gasto?')) {
                gastos.splice(index, 1);
                actualizarTabla();
                mostrarAlerta('üóëÔ∏è Gasto eliminado');
            }
        }

        function eliminarTodo() {
            if (confirm('¬øEliminar TODOS los gastos?')) {
                gastos = [];
                actualizarTabla();
                mostrarAlerta('üóëÔ∏è Todos los gastos eliminados', 'error');
            }
        }

        function exportarExcel() {
            const wb = XLSX.utils.book_new();
            const data = gastos.map(g => ({
                Fecha: new Date(g.fecha).toLocaleDateString('es-CL'),
                'Tipo Gasto': g.tipoGasto,
                'Tipo Doc': g.tipoDoc,
                'N¬∞ Doc': g.numDoc,
                RUT: g.rut,
                Empresa: g.empresa,
                Monto: parseFloat(g.monto),
                Descripci√≥n: g.descripcion,
                Im√°genes: g.imagenes ? g.imagenes.join('; ') : ''
            }));
            const ws = XLSX.utils.json_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, 'Gastos');
            XLSX.writeFile(wb, `Rendicion_Gastos_TOOLTEK_${new Date().toISOString().split('T')[0]}.xlsx`);
            mostrarAlerta('üì• Excel exportado');
        }

        // Eventos
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('fecha').value = new Date().toISOString().split('T')[0];
            document.getElementById('tipoDoc').addEventListener('change', (e) => {
                document.getElementById('rut').required = e.target.value === 'Factura';
                if (e.target.value !== 'Factura') document.getElementById('rut').value = '';
            });
            document.getElementById('imagenes').addEventListener('change', async (e) => {
                imagenesActuales = await archivosABase64(e.target.files);
            });
            document.getElementById('btnAgregar').addEventListener('click', agregarGasto);
            document.getElementById('btnLimpiar').addEventListener('click', limpiarFormulario);
            document.getElementById('btnEliminarTodo').addEventListener('click', eliminarTodo);
            document.getElementById('btnExportar').addEventListener('click', exportarExcel);
            actualizarTabla();
        });
    </script>
</body>
</html>
