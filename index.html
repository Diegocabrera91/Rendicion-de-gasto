<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rendición de Gastos Empresarial</title>

<script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>

<style>
/* Mantén tus estilos aquí (igual que antes) */
</style>
</head>
<body>

<header>
    <h2>Rendición de Gastos Empresarial</h2>
    <div id="fechaActual"></div>
</header>

<div class="container">
   <div id="alertContainer"></div>

   <div class="card">
       <h3>Registrar Nuevo Gasto</h3>
       <div class="form-grid">
           <input id="fecha" type="date">
           <select id="tipoGasto">
               <option value="">Tipo de Gasto</option>
               <option>Traslado</option>
               <option>Alimentación</option>
               <option>Hospedaje</option>
               <option>Combustible</option>
               <option>Otros</option>
           </select>
           <select id="tipoDocumento">
               <option value="">Tipo Documento</option>
               <option>Factura</option>
               <option>Boleta</option>
           </select>
           <input id="numeroDocumento" placeholder="N° Documento">
           <input id="empresa" placeholder="Empresa">
           <input id="monto" type="number" placeholder="Monto CLP">
           <textarea id="descripcion" placeholder="Descripción"></textarea>
           <input id="imagen" type="file" accept="image/*">
       </div>

       <div class="button-group">
           <button type="button" id="btnGuardar" class="btn-primary">Guardar</button>
           <button type="button" id="btnLimpiar" class="btn-secondary">Limpiar</button>
           <button type="button" id="btnEliminarTodo" class="btn-danger">Eliminar Todo</button>
       </div>
   </div>

   <div class="card">
       <h3>Listado de Gastos</h3>
       <div id="tablaGastos" class="table-wrapper"></div>

       <div class="button-group">
           <button type="button" id="btnExportar" class="btn-success">Exportar Excel con Imágenes</button>
           <button type="button" id="btnCorreo" class="btn-secondary">Enviar por Correo</button>
       </div>
   </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function(){

    // Variables seguras
    const STORAGE_KEY="gastos_empresa_final_v2";

    const fechaInput=document.getElementById("fecha");
    const tipoGastoInput=document.getElementById("tipoGasto");
    const tipoDocInput=document.getElementById("tipoDocumento");
    const numDocInput=document.getElementById("numeroDocumento");
    const empresaInput=document.getElementById("empresa");
    const montoInput=document.getElementById("monto");
    const descInput=document.getElementById("descripcion");
    const imgInput=document.getElementById("imagen");
    const tablaGastos=document.getElementById("tablaGastos");
    const alertContainer=document.getElementById("alertContainer");

    function cargarGastos(){
        return JSON.parse(localStorage.getItem(STORAGE_KEY))||[];
    }

    function guardarGastos(g){
        localStorage.setItem(STORAGE_KEY,JSON.stringify(g));
        actualizarTabla();
    }

    function mostrarAlerta(m,t){
        alertContainer.innerHTML = `<div class="alert ${t}">${m}</div>`;
        setTimeout(()=> alertContainer.innerHTML="",3000);
    }

    function limpiarFormulario(){
        fechaInput.value="";
        tipoGastoInput.value="";
        tipoDocInput.value="";
        numDocInput.value="";
        empresaInput.value="";
        montoInput.value="";
        descInput.value="";
        imgInput.value="";
    }

    function actualizarTabla(){
        const gastos = cargarGastos();
        if(!gastos.length){
            tablaGastos.innerHTML = "<p>Sin registros</p>";
            return;
        }
        let html=`<table><thead><tr>
            <th>Fecha</th><th>Tipo</th><th>Doc</th><th>Empresa</th><th>Monto</th><th>Img</th>
        </tr></thead><tbody>`;

        gastos.forEach(g=>{
            html += `<tr>
                <td>${new Date(g.fecha).toLocaleDateString("es-CL")}</td>
                <td>${g.tipoGasto}</td>
                <td>${g.tipoDocumento} ${g.numeroDocumento}</td>
                <td>${g.empresa}</td>
                <td class="currency">$${g.monto.toLocaleString("es-CL")}</td>
                <td>${g.imagen?`<img src="${g.imagen}" class="preview">`:"—"}</td>
            </tr>`;
        });

        html += `</tbody></table>`;
        tablaGastos.innerHTML=html;
    }

    function agregarGasto(){
        const fecha=fechaInput.value;
        const tipoGasto=tipoGastoInput.value;
        const tipoDoc=tipoDocInput.value;
        const numeroDoc=numDocInput.value;
        const empresa=empresaInput.value;
        const monto=parseFloat(montoInput.value);

        if(!fecha||!tipoGasto||!tipoDoc||!numeroDoc||!empresa||isNaN(monto)){
            mostrarAlerta("Completa campos obligatorios","error");
            return;
        }

        const file = imgInput.files && imgInput.files.length>0 ? imgInput.files[0] : null;

        if(file){
            const reader = new FileReader();
            reader.onload = e => {
                guardarGastos([...cargarGastos(), {
                    id: Date.now(),
                    fecha,
                    tipoGasto,
                    tipoDocumento: tipoDoc,
                    numeroDocumento: numeroDoc,
                    empresa,
                    monto,
                    descripcion: descInput.value,
                    imagen: e.target.result
                }]);
                limpiarFormulario();
                mostrarAlerta("Gasto agregado","success");
            };
            reader.readAsDataURL(file);
        } else {
            guardarGastos([...cargarGastos(), {
                id:Date.now(),
                fecha,
                tipoGasto,
                tipoDocumento: tipoDoc,
                numeroDocumento: numeroDoc,
                empresa,
                monto,
                descripcion: descInput.value,
                imagen:null
            }]);
            limpiarFormulario();
            mostrarAlerta("Gasto agregado","success");
        }
    }

    // EVENTOS
    document.getElementById("btnGuardar").onclick = agregarGasto;
    document.getElementById("btnLimpiar").onclick = limpiarFormulario;
    document.getElementById("btnEliminarTodo").onclick = ()=>{
        localStorage.removeItem(STORAGE_KEY);
        actualizarTabla();
    };

    actualizarTabla();

});
</script>

</body>
</html>
